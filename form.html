<!DOCTYPE html>
<html lang="pt_BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nota | Devsnotes</title>
  <script src="js/util.js"></script>
  <script src="js/token.js"></script>
  <script>
    if (! token) {
      window.location = 'login.html'
    }

    const urlParams = new URLSearchParams(window.location.search)
    let id = urlParams.get('id')

    if (! id) {
      document.title = 'Nova ' + document.title
    }
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <main>
    <div class="container">
      <h1 id="page-title">Nota</h1>

      <form action="notes.html" method="POST" data-url="http://localhost:8000/api/note">
        <div class="card">
          <div class="card-body">
            <div class="form-group">
              <input type="text" name="title" autocomplete="off" autofocus placeholder="Titulo" class="form-control">
            </div>

            <div class="form-group">
              <textarea name="body" cols="30" rows="10" placeholder="Deixe uma descrição" class="form-control"></textarea>
            </div>
          </div>

          <div class="card-footer text-center">
            <!-- <button type="submit" class="btn btn-success">Salvar Nota</button> -->
          </div>
        </div>
      </form>
  </main>
  <script src="js/validation.js"></script>
  <script>
    const form = document.querySelector('form')
    let data = {
      'title': form.title.value,
      'body': form.body.value
    }

    if (id) {
      form.action = `note.html?id=${id}`
      form.dataset.url += `/${id}`
      ajax(form.dataset.url, 'GET', updateFields, null, token)
    }

    form.addEventListener('submit', e => Validator.handleSubmit(e, form, processNote, token))

    function processNote(res) {
      console.log(res)

      if (res['error'] && typeof(res['error']) == 'object') {
        for (let name in res['error']) {
          let error = res['error'][name][0]
          let input = form.querySelector(`#${name}`) || form.querySelector(`*[name=${name}]`)
          Validator.showError(input, error)
        }

        return false
      }
    }

    function updateFields(res, status) {
      let note = res['note']
      let title = document.querySelector('#page-title')

      if (note) {
        title.innerHTML = note['title']

        form.title.value = note['title']
        form.body.innerHTML = note['body']

        let eMethod = document.createElement('input')
        eMethod.type = 'hidden'
        eMethod.name = 'method'
        eMethod.value = 'PUT'
        form.appendChild(eMethod)
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
</body>
</html>